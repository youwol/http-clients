name: Test

on:
    workflow_dispatch:
        inputs:
            py-youwol-ref:
                description: py-youwol ref to use
                default: 'main'
                required: false
                type: string
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - develop

jobs:
    integration_with_py-youwol:
        runs-on: ubuntu-latest
        steps:
            - name: Prepare repository
              id: prepare
              uses: youwol/nestor/ts/prepare@v1

            - name: Start py-youwol
              id: start_py-youwol
              uses: youwol/nestor/py-youwol/start@v1
              with:
                  ref: ${{ inputs.py-youwol-ref }}
                  conf_repository: youwol/integrations-tests-conf
                  conf_path: yw_config_IT.py

            - name: Run Yarn Coverage
              id: run_yarn_coverage
              continue-on-error: true
              uses: youwol/nestor/ts/coverage@v1

            - name: Stop py-youwol
              id: stop_py-youwol
              uses: youwol/nestor/py-youwol/stop@v1
              with:
                  instance: ${{ steps.start_py-youwol.outputs.instance }}

            - name: On Yarn Coverage Failure
              id: yarn_coverage_failure
              if: steps.run_yarn_coverage.outputs.result != 'success'
              uses: actions/github-script@v6
              with:
                  script: core.setFailed("Job failed because tests has failed, see job logs")

    static_analysis:
        runs-on: ubuntu-latest
        steps:
            - name: Prepare repository
              id: prepare
              uses: youwol/nestor/ts/prepare@v1

            - name: Static Analysis
              id: static_analysis
              uses: youwol/nestor/ts/static_analysis@v1

            - name: On Yarn Coverage Failure
              id: yarn_coverage_failure
              if: steps.static_analysis.outputs.result == 'failure'
              uses: actions/github-script@v6
              with:
                  script: core.setFailed("Job failed because static analysis has failed, see job logs")
